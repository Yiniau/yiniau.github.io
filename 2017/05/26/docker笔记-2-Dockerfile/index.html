<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> docker笔记_2_Dockerfile · Yiniau's blog</title><meta name="description" content="docker笔记_2_Dockerfile - yiniau"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yiniau.com/atom.xml" title="Yiniau's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/categories/" target="_self" class="nav-list-link">CATEGORIES</a></li><li class="nav-list-item"><a href="https://github.com/yiniau" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">docker笔记_2_Dockerfile</h1><div class="post-info">2017年5月26日</div><div class="post-content"><h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><p>image 采用Union-FS分层储存，通过 <code>docker commit</code> 可以保存容器的储存层为一个新的镜像，也就是将运行时储存层持久化为 image 中的一层结构</p>
<p>但是直接使用 commit 会出现诸多问题，使用 <code>docker diff &lt;container name|ID|shareID&gt;</code> 可以观察到commit之前之后的变动，在一个命令被执行后会有大量无关内容被添加，特别是一些安装软件的命令。直接使用 commit 很容易造成 image 臃肿，使用 commit 生成的 image 也被称为 <strong>黑箱镜像</strong>（生成过程不透明）。</p>
<p>docker 官方最佳实践的做法为使用 <strong>Dockerfile</strong> 定制image</p>
<h4 id="主要指令"><a href="#主要指令" class="headerlink" title="主要指令"></a>主要指令</h4><ul>
<li>FROM 制定基础镜像</li>
<li>RUN  执行命令</li>
<li>COPY 复制文件</li>
<li>ADD  高级的复制文件指令</li>
<li>CMD  容器启动命令</li>
<li>ENTRYPOINT 入口文件</li>
<li>ENV  设置环境变量</li>
<li>ARG  构建参数</li>
<li>VOLUME 定义匿名卷（数据卷）</li>
<li>EXPOSE 暴露接口</li>
<li>WORKDIR 制定工作目录</li>
<li>USER    制定当前用户</li>
<li>HEALTHCHECK 健康检查</li>
<li>ONBUILD 为他人做嫁衣</li>
</ul>
<p>在 Dockerfile 中每出现一个 <code>RUN</code> 就会多构建一层镜像</p>
<h4 id="使用-Dockerfile-定义-container"><a href="#使用-Dockerfile-定义-container" class="headerlink" title="使用 Dockerfile 定义 container"></a>使用 Dockerfile 定义 container</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">FROM debian:jessie</div><div class="line"></div><div class="line">RUN apt-get update</div><div class="line">RUN apt-get install -y gcc libc6-dev make</div><div class="line">RUN wget -O redis.tar.gz <span class="string">"http://download.redis.io/releases/redis-3.2.5.tar.gz"</span></div><div class="line">RUN mkdir -p /usr/src/redis</div><div class="line">RUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1</div><div class="line">RUN make -C /usr/src/redis</div><div class="line">RUN make -C /usr/src/redis install</div></pre></td></tr></table></figure>
<p>上面的 Dockerfile 会新建7层镜像，多出了许多没有意义的，运行时不需要的东西。</p>
<p>这些RUN命令的目的是编译安装<code>redis</code>可执行文件，只需要用1层代替即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">FROM debian:jessie</div><div class="line"></div><div class="line">RUN buildDeps=<span class="string">'gcc libc6-dev make'</span> \</div><div class="line">    &amp;&amp; apt-get update \</div><div class="line">    &amp;&amp; apt-get install -y <span class="variable">$buildDeps</span> \</div><div class="line">    &amp;&amp; wget -O redis.tar.gz <span class="string">"http://download.redis.io/releases/redis-3.2.5.tar.gz"</span> \</div><div class="line">    &amp;&amp; mkdir -p /usr/src/redis \</div><div class="line">    &amp;&amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \</div><div class="line">    &amp;&amp; make -C /usr/src/redis \</div><div class="line">    &amp;&amp; make -C /usr/src/redis install \</div><div class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/* \</div><div class="line">    &amp;&amp; rm redis.tar.gz \</div><div class="line">    &amp;&amp; rm -r /usr/src/redis \</div><div class="line">    &amp;&amp; apt-get purge -y --auto-remove <span class="variable">$buildDeps</span></div></pre></td></tr></table></figure>
<p>使用 <code>&amp;&amp;</code> 将所需命令串街起来，简化为1层。<br>Dockerfile 支持使用 <code>\</code> 对命令进行换行，格式化命令代码。</p>
<p>下面是一个大体的例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Use an official Python runtime as a base image</span></div><div class="line"><span class="comment"># 使用一个官方的 Python runtime 作为基础镜像</span></div><div class="line">FROM python:2.7-slim</div><div class="line"></div><div class="line"><span class="comment"># Set the working directory to /app</span></div><div class="line"><span class="comment"># 将工作目录设置到 /app</span></div><div class="line">WORKDIR /app</div><div class="line"></div><div class="line"><span class="comment"># Copy the current directory contents into the container at /app</span></div><div class="line"><span class="comment"># 复制当前目录下的内容到容器文件系统的 /app 下</span></div><div class="line">ADD . /app</div><div class="line"></div><div class="line"><span class="comment"># Install any needed packages specified in requirements.txt</span></div><div class="line"><span class="comment"># 安装任何需要的在 requirements.txt 中说明的 packages</span></div><div class="line">RUN pip install -r requirements.txt</div><div class="line"></div><div class="line"><span class="comment"># Make port 80 available to the world outside this container</span></div><div class="line"><span class="comment"># 将 80 端口暴露给 contanier 外部</span></div><div class="line">EXPOSE 80</div><div class="line"></div><div class="line"><span class="comment"># Define environment variable</span></div><div class="line"><span class="comment"># 定义环境变量</span></div><div class="line">ENV NAME World</div><div class="line"></div><div class="line"><span class="comment"># Run app.py when the container launches</span></div><div class="line"><span class="comment"># 当 container 启动是运行 app.py</span></div><div class="line">CMD [<span class="string">"python"</span>, <span class="string">"app.py"</span>]</div></pre></td></tr></table></figure>
<p>这个 <code>Dockerfile</code> 文件还包含了几个我们还没有创建的文件，即 <code>app.py</code> 和 <code>requirements.txt</code>。</p>
<p>接下来就是完成这两个文件了</p>
<h4 id="应用本身"><a href="#应用本身" class="headerlink" title="应用本身"></a>应用本身</h4><p>抓取将这两个文件并将他们放在 dockerfile 所在的文件夹下。</p>
<p>这就已经完成了一个应用，十分简单。</p>
<blockquote>
<p>当前面的 <code>Dockerfile</code> 被 build 成 image 时，<code>app.py</code> 和 <code>requirements.txt</code> 会被 <code>ADD</code> 命令添加，而 <code>app.py</code> 的输出则能通过 <code>EXPOSE</code> 命令使外部能够通过 HTTP 访问。</p>
</blockquote>
<p><strong>requriements.txt</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Flask</div><div class="line">Redis</div></pre></td></tr></table></figure>
<p><strong>app.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</div><div class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis, RedisError</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> socket</div><div class="line"></div><div class="line"><span class="comment"># Connect to Redis</span></div><div class="line">redis = Redis(host=<span class="string">"redis"</span>, db=<span class="number">0</span>, socket_connect_timeout=<span class="number">2</span>, socket_timeout=<span class="number">2</span>)</div><div class="line"></div><div class="line">app = Flask(__name__)</div><div class="line"></div><div class="line"><span class="meta">@app.route("/")</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        visits = redis.incr(<span class="string">"counter"</span>)</div><div class="line">    <span class="keyword">except</span> RedisError:</div><div class="line">        visits = <span class="string">"&lt;i&gt;cannot connect to Redis, counter disabled&lt;/i&gt;"</span></div><div class="line"></div><div class="line">    html = <span class="string">"&lt;h3&gt;Hello &#123;name&#125;!&lt;/h3&gt;"</span> \</div><div class="line">           <span class="string">"&lt;b&gt;Hostname:&lt;/b&gt; &#123;hostname&#125;&lt;br/&gt;"</span> \</div><div class="line">           <span class="string">"&lt;b&gt;Visits:&lt;/b&gt; &#123;visits&#125;"</span></div><div class="line">    <span class="keyword">return</span> html.format(name=os.getenv(<span class="string">"NAME"</span>, <span class="string">"world"</span>), hostname=socket.gethostname(), visits=visits)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">	app.run(host=<span class="string">'0.0.0.0'</span>, port=<span class="number">80</span>)</div></pre></td></tr></table></figure>
<p>现在将看到 <code>pip install -r requirements.txt</code> 会为Python安装Flask和Redis库，并且app将会打印出环境变量 <code>NAME</code>，并且输出<code>socket.gethostname()</code>的结果。<br>最终，由于 Redis 没有在运行(因为只安装了Python库，并不是Redis自身)，我们能够预计尝试使用它的时候会失败并产生错误信息。</p>
<h4 id="Build-the-App"><a href="#Build-the-App" class="headerlink" title="Build the App"></a>Build the App</h4><p>构建开始前在系统中并不需要Python或者其他任何在requirements.txt文件中求的东西，也不会将用于构建image的库安装到主机系统上。</p>
<p>运行编译命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker build -t friendlyhello .</div></pre></td></tr></table></figure>
<p>查看images</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker images</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">docker images</div><div class="line"></div><div class="line">REPOSITORY                                  TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">friendlyhello                               latest              d5a69ab6bd43        24 hours ago        195 MB</div></pre></td></tr></table></figure>
<p>运行后会出现一个个通知，指出Python正在 <a href="http://0.0.0.0:80" target="_blank" rel="external">http://0.0.0.0:80</a> 为你的应用程序提供服务。 但是，该消息来自容器内部，并不知道你通过 <code>EXPOSE</code> 将该容器的80端口暴露并在启动命令中remapping80到4000，正确的URL为 <strong>http：// localhost：4000</strong>。 在浏览器中访问，你会看到“Hello World”文本，容器ID和Redis错误信息。</p>
<h4 id="run-应用"><a href="#run-应用" class="headerlink" title="run 应用"></a>run 应用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -p 4000:80 friendlyhello</div></pre></td></tr></table></figure>
<p>将会在运行 friendlyhello ，并将在 Dockerfile 中使用 <code>EXPOSE</code> 暴露的 80 端口并重映射到 4000。</p>
<p>运行之后将提示信息，提示在 <code>http://0.0.0.0:80</code> 中运行服务，但这是在 container 中的地址，主机访问的正确地址为 <code>http://localhost:4000</code>。</p>
<p><strong>后台运行 | 分离模式</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d -p 4000:80 friendlyhello</div></pre></td></tr></table></figure>
<p>运行后会得到一条巨长的 container ID,可以使用 <code>docker ps</code> 查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">docker ps</div><div class="line"></div><div class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                  NAMES</div><div class="line">ed4cab2deb90        friendlyhello       <span class="string">"python app.py"</span>     24 hours ago        Up About a minute   0.0.0.0:4000-&gt;80/tcp   sad_curie</div></pre></td></tr></table></figure>
<p>使用 <code>docker stop ed4cab2deb90</code> 即可停止运行。</p>
<h4 id="命令总结"><a href="#命令总结" class="headerlink" title="命令总结"></a>命令总结</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">docker build -t friendlyname .  <span class="comment"># Create image using this directory's Dockerfile</span></div><div class="line">docker run -p 4000:80 friendlyname  <span class="comment"># Run "friendlyname" mapping port 4000 to 80</span></div><div class="line">docker run -d -p 4000:80 friendlyname         <span class="comment"># Same thing, but in detached mode</span></div><div class="line">docker ps                                 <span class="comment"># See a list of all running containers</span></div><div class="line">docker stop &lt;<span class="built_in">hash</span>&gt;                     <span class="comment"># Gracefully stop the specified container</span></div><div class="line">docker ps -a           <span class="comment"># See a list of all containers, even the ones not running</span></div><div class="line">docker <span class="built_in">kill</span> &lt;<span class="built_in">hash</span>&gt;                   <span class="comment"># Force shutdown of the specified container</span></div><div class="line">docker rm &lt;<span class="built_in">hash</span>&gt;              <span class="comment"># Remove the specified container from this machine</span></div><div class="line">docker rm $(docker ps -a -q)           <span class="comment"># Remove all containers from this machine</span></div><div class="line">docker images -a                               <span class="comment"># Show all images on this machine</span></div><div class="line">docker rmi &lt;imagename&gt;            <span class="comment"># Remove the specified image from this machine</span></div><div class="line">docker rmi $(docker images -q)             <span class="comment"># Remove all images from this machine</span></div><div class="line">docker login             <span class="comment"># Log in this CLI session using your Docker credentials</span></div><div class="line">docker tag &lt;image&gt; username/repository:tag  <span class="comment"># Tag &lt;image&gt; for upload to registry</span></div><div class="line">docker push username/repository:tag            <span class="comment"># Upload tagged image to registry</span></div><div class="line">docker run username/repository:tag                   <span class="comment"># Run image from a registry</span></div></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2017/06/20/E10S-Multi-WebExtension-APIs-CSS-clip-path-md/" class="prev">上一篇</a><a href="/2017/05/25/docker笔记_1/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 <a href="http://yiniau.com">yiniau</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>